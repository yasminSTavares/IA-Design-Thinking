<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat com Cadastro e Senha</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; max-width: 600px; }
  #login, #chat { margin-top: 20px; }
  #mensagens { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: auto; background:#fafafa; margin-bottom:10px; }
  button { margin-left: 5px; }
</style>
</head>
<body>

<h2>Chat de Ideias - Design Thinking</h2>

<div id="login">
  <h3>Login ou Cadastro</h3>
  <input type="text" id="usernameInput" placeholder="Usuário" />
  <input type="password" id="passwordInput" placeholder="Senha" />
  <button onclick="login()">Entrar / Cadastrar</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<div id="chat" style="display:none;">
  <p>Usuário: <b id="usuarioAtual"></b> <button onclick="logout()">Sair</button></p>
  
  <div id="mensagens"></div>
  
  <input type="text" id="inputChat" placeholder="Digite sua ideia aqui..." style="width: 80%;" />
  <button onclick="enviarMensagem()">Enviar</button>
  <button onclick="gerarPDF()">Gerar PDF</button>
</div>

<script>
  const usuariosKey = 'chatUsuarios'; // para armazenar usuários e senhas
  const mensagensKeyPrefix = 'chatMensagens_'; // mensagens serão salvas com prefixo + username

  let usuarioAtual = null;
  let editandoIndex = null;

  // Carrega usuários do localStorage
  function carregarUsuarios() {
    return JSON.parse(localStorage.getItem(usuariosKey)) || {};
  }

  // Salva usuários no localStorage
  function salvarUsuarios(usuarios) {
    localStorage.setItem(usuariosKey, JSON.stringify(usuarios));
  }

  // Login ou cadastro
  function login() {
    const username = document.getElementById('usernameInput').value.trim();
    const password = document.getElementById('passwordInput').value.trim();
    const loginMsg = document.getElementById('loginMsg');
    loginMsg.textContent = '';

    if (!username || !password) {
      loginMsg.textContent = 'Informe usuário e senha.';
      return;
    }

    let usuarios = carregarUsuarios();

    if (usuarios[username]) {
      // Usuário existe - verificar senha
      if (usuarios[username] === password) {
        entrarChat(username);
      } else {
        loginMsg.textContent = 'Senha incorreta.';
      }
    } else {
      // Cadastrar novo usuário
      usuarios[username] = password;
      salvarUsuarios(usuarios);
      alert('Usuário cadastrado com sucesso!');
      entrarChat(username);
    }
  }

  // Entrar no chat após login
  function entrarChat(username) {
    usuarioAtual = username;
    document.getElementById('usuarioAtual').textContent = usuarioAtual;
    document.getElementById('login').style.display = 'none';
    document.getElementById('chat').style.display = 'block';
    carregarMensagens();
  }

  // Logout
  function logout() {
    usuarioAtual = null;
    editandoIndex = null;
    document.getElementById('inputChat').value = '';
    document.getElementById('loginMsg').textContent = '';
    document.getElementById('usernameInput').value = '';
    document.getElementById('passwordInput').value = '';
    document.getElementById('chat').style.display = 'none';
    document.getElementById('login').style.display = 'block';
    document.getElementById('mensagens').innerHTML = '';
  }

  // Carregar mensagens do usuário atual
  function carregarMensagens() {
    if (!usuarioAtual) return;
    const divMensagens = document.getElementById('mensagens');
    const msgs = JSON.parse(localStorage.getItem(mensagensKeyPrefix + usuarioAtual)) || [];

    divMensagens.innerHTML = msgs.map((msg, index) => `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
        <span>• ${msg}</span>
        <div>
          <button onclick="editarMensagem(${index})" style="background:none; border:none; color:orange; font-size:16px; cursor:pointer;">✏️</button>
          <button onclick="removerMensagem(${index})" style="background:none; border:none; color:red; font-size:16px; cursor:pointer;">🗑️</button>
        </div>
      </div>
    `).join('');

    divMensagens.scrollTop = divMensagens.scrollHeight;
  }

  function removerMensagem(index) {
    if (!usuarioAtual) return;
    const msgs = JSON.parse(localStorage.getItem(mensagensKeyPrefix + usuarioAtual)) || [];
    msgs.splice(index, 1);
    localStorage.setItem(mensagensKeyPrefix + usuarioAtual, JSON.stringify(msgs));
    carregarMensagens();
  }

  function editarMensagem(index) {
    if (!usuarioAtual) return;
    const msgs = JSON.parse(localStorage.getItem(mensagensKeyPrefix + usuarioAtual)) || [];
    const input = document.getElementById('inputChat');
    input.value = msgs[index];
    editandoIndex = index;
    input.focus();
  }

  function enviarMensagem() {
    if (!usuarioAtual) return alert('Faça login antes de enviar mensagens.');
    const input = document.getElementById('inputChat');
    const texto = input.value.trim();
    if (!texto) return alert('Digite uma ideia antes de enviar!');

    const msgs = JSON.parse(localStorage.getItem(mensagensKeyPrefix + usuarioAtual)) || [];

    if (editandoIndex !== null) {
      msgs[editandoIndex] = texto;
      editandoIndex = null;
    } else {
      msgs.push(texto);
    }

    localStorage.setItem(mensagensKeyPrefix + usuarioAtual, JSON.stringify(msgs));
    input.value = '';
    carregarMensagens();
  }

  async function gerarPDF() {
    if (!usuarioAtual) return alert('Faça login antes de gerar PDF.');
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const msgs = JSON.parse(localStorage.getItem(mensagensKeyPrefix + usuarioAtual)) || [];
    if (msgs.length === 0) {
      alert('Não há ideias para gerar PDF.');
      return;
    }

    doc.setFontSize(18);
    doc.text(`Ideias do Chat - Design Thinking (${usuarioAtual})`, 10, 20);
    doc.setFontSize(12);
    let y = 40;
    msgs.forEach((msg, i) => {
      const texto = `${i + 1}. ${msg}`;
      const splitText = doc.splitTextToSize(texto, 180);
      doc.text(splitText, 10, y);
      y += splitText.length * 10;
      if (y > 280) {
        doc.addPage();
        y = 20;
      }
    });

    doc.save(`ideias_design_thinking_${usuarioAtual}.pdf`);
  }

  window.onload = () => {
    // Por enquanto começa na tela de login
  };
</script>

<!-- Importa jsPDF da CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>
